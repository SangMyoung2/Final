<html layout:decorate="~{layout}">
<head>
<meta charset="UTF-8">

<title>아티클</title>


<style>
    footer{
        position: static !important;
    }
</style>

<link rel="stylesheet" type="text/css" th:href="@{http://localhost:8080/css/index.css}"/>
<link rel="stylesheet" type="text/css" th:href="@{http://localhost:8080/css/bbsYj/articleYj.css}"/>
<link rel="icon" type="image/png" th:href="@{http://localhost:8080/image/로고.png}"/>
<link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.2/dist/css/bootstrap.min.css" rel="stylesheet" integrity="sha384-T3c6CoIi6uLrA9TneNEoa7RxnatzjcDSCmG1MXxSR1GAsXEV/Dwwykc2MPK8M2HN" crossorigin="anonymous"/>
<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script src="https://kit.fontawesome.com/171f74c68f.js" crossorigin="anonymous"></script>


<script>

    // 페이지 로드 시 초기 버튼 상태 설정
    document.addEventListener('DOMContentLoaded', function() {
        var homeButton = document.querySelector('#btnradio1');
        var reviewButton = document.querySelector('#btnradio2');

        if (window.location.hash === '#review') {
            // 리뷰 버튼이 선택된 상태로 초기화
            reviewButton.checked = true;
            showReviewContent();
        } else {
            // 홈 버튼이 선택된 상태로 초기화
            homeButton.checked = true;
            showHomeContent();
        }

        // 버튼 클릭 시 해시 변경
        homeButton.addEventListener('click', function() {
            window.location.hash = '#home';
            showHomeContent();
        });


});

    // 홈 내용 표시 함수
    function showHomeContent() {
        document.querySelector('.yj-img').style.display = 'block';
        document.querySelector('.yj-img2').style.display = 'none';
        document.querySelector('.meet-members').style.display = 'block';
    }

    // 리뷰 내용 표시 함수
    function showReviewContent() {
        document.querySelector('.yj-img').style.display = 'none';
        document.querySelector('.yj-img2').style.display = 'block';
        document.querySelector('.meet-members').style.display = 'none';
    }


    document.addEventListener('DOMContentLoaded', function() {

        var reviewForm = document.querySelector('.review-form');
        var reviewWriteButton = document.querySelector('.review-write');

        reviewWriteButton.addEventListener('click', function() {
            if (reviewForm.style.display === 'block') {
                reviewForm.style.display = 'none';
            } else {
                reviewForm.style.display = 'block';
            }
            
        });

        //리뷰 등록
    document.querySelector('#submit-review').addEventListener('click', function(e) {
        e.preventDefault(); // 기본 이벤트 동작 방지 (페이지 새로고침 방지)

            var challengeListNum = document.querySelector('#challengeListNum').value;
            var challengeAuthContent= document.querySelector('#challengeAuthContent').value;
            var challengeAuthImage = document.querySelector('#challengeAuthImage').files[0];

            // 리뷰 내용과 이미지 모두 필수로 입력되어야 함
            if (challengeAuthContent.trim() === '' && !challengeAuthImage) {
                alert('내용과 이미지를 모두 작성해주세요.');
            } else if (!challengeAuthImage) {
                alert('이미지를 첨부해주세요.');
            } else if (challengeAuthContent.trim() === '') {
                alert('내용을 작성해주세요.');
            } else {
                // 이미지 파일을 FormData에 추가
                var formData = new FormData();
                formData.append('challengeListNum', challengeListNum);
                formData.append('challengeAuthContent', challengeAuthContent);
                formData.append('challengeAuthImage', challengeAuthImage);


                $.ajax({
                    url: '/uploadAuth',
                    method: 'POST',
                    data: formData,
                    processData: false, // 필수: formData 처리 비활성화
                    contentType: false, // 필수: 콘텐츠 타입 비활성화
                    success: function(response) {
                        if (response === 'success') {
                            alert('리뷰가 게시되었습니다.');
                          // 이미지 파일 선택 초기화
                          location.reload();
                           
                        } else if (response === 'already-reviewed') {
                            alert('이미 리뷰를 작성하셨습니다.');
                            
                        }
                    },
                    error: function(xhr, status, error) {
                        alert('오류 발생: ' + status);
                    }
                });

            }
        });


        
    });

// 모달 창 열기
function openModal(imgElement) {
        // 모달 창 엘리먼트 생성
        var modal = document.createElement('div');
        modal.className = 'modal';
        
        // 모달 이미지 엘리먼트 생성
        var modalImg = document.createElement('img');
        modalImg.className = 'modal-content';
        modalImg.src = imgElement.src;
        
        // 모달 창에 이미지 추가
        modal.appendChild(modalImg);
        
        // 모달 창 스타일 설정
        modal.style.display = 'block';
        
        // 모달 창을 body에 추가
        document.body.appendChild(modal);
        
        // 모달 창을 클릭하면 닫히도록 이벤트 핸들러 추가
        modal.onclick = function() {
            modal.style.display = 'none';
            modal.remove(); // 모달 창 제거
        };
    }

    


    //리뷰삭제
    function deleteReview(email, challengeListNum, challengeAuthListNum ,challengeAuthImage) {
        if (confirm('리뷰를 삭제하시겠습니까?')) {
            $.ajax({
                type: "POST",
                url: "/deleteChallengeReview",
                data: {
                    challengeListNum: challengeListNum,
                    challengeAuthListNum: challengeAuthListNum,
                    email: email,
                    challengeAuthImage: challengeAuthImage
                },
                success: function (response) {
                    alert('삭제되었습니다.');
                    location.reload();
                },
                error: function () {
                    alert('삭제에 실패했습니다.');
                }
            });
        }
    }

function joinMeet(){

let title = document.getElementById('meetTitle').textContent;
let money = document.getElementById('meetMoney').textContent;

let checkJoin = confirm(title + ' 모임의 가입비는 ' + money + '입니다.' + '\n' + title + ' 모임에 가입하시겠습니까?');

let meetListNum = document.getElementById('meetListNum').value;
if(checkJoin){
    $.ajax({
            type: "POST",
            url: "/checkuserpoint",
            data: {
                meetListNum: meetListNum
            },
            success: function (response) {
                alert(response);
                if(response){
                    location.href = '/join-meet?meetListNum='+meetListNum;
                }else{
                    alert('포인트가 부족합니다.');
                }
            },
            error: function () {
                alert('다시 시도 해주세요..');
            }
        });
}
}


function joinCancel(){
    let meetListNum = document.getElementById('meetListNum').value;
    let title = document.getElementById('meetTitle').textContent;

    let joincancel = confirm(title + ' 모임의 가입을 취소하시겠습니까?');
    if(joincancel){
        $.ajax({
                type: "POST",
                url: "/joincancel",
                data: {
                    meetListNum: meetListNum
                },
                success: function (response) {
                    if(response){
                        location.href = '/articleYj.action?meetListNum='+meetListNum;
                    }else{
                        alert('이미 가입되셨습니다...');
                    }
                },
                error: function () {
                    alert('다시 시도 해주세요..');
                }
            });
    }
}

function deleteMeet() {
    let meetListNum = document.getElementById('meetListNum').value;
    let title = document.getElementById('meetTitle').textContent;

    let joincancel = confirm(title + ' 모임을 삭제하시겠습니까?');
    if(joincancel){
        $.ajax({
                type: "POST",
                url: "/meettimecheck",
                data: {
                    meetListNum: meetListNum
                },
                success: function (response) {
                    if(response == 1){
                        alert('취소 되었습니다.');
                        location.href = '/delete-meet?meetListNum='+meetListNum;
                    }else if(response === 2){
                        alert('모임 시간이 지났습니다.');
                    }
                    else{
                        alert('다시 시도해 주세요..');
                    }
                },
                error: function () {
                    alert('다시 시도 해주세요..');
                }
            });
    }
}

function outmeet(){
    let meetListNum = document.getElementById('meetListNum').value;
    let title = document.getElementById('meetTitle').textContent;

    let joincancel = confirm(title + ' 모임을 탈퇴 하시겠습니까?');
    if(joincancel){
        $.ajax({
                type: "POST",
                url: "/meettimecheck",
                data: {
                    meetListNum: meetListNum
                },
                success: function (response) {
                    if(response == 1){
                        alert('탈퇴 되었습니다.');
                        location.href = '/out-meet?meetListNum='+meetListNum;
                    }else if(response === 2){
                        alert('모임 시간이 지났습니다.');
                    }
                    else{
                        alert('다시 시도해 주세요..');
                    }
                },
                error: function () {
                    alert('다시 시도 해주세요..');
                }
            });
    }
}


    function inputNumberWithComma(str) {
        str = String(str);
        return str.replace(/\B(?=(\d{3})+(?!\d))/g, ",");
    }

  

</script>
<style>
tr{
    text-align: center;
}

            tr:first-child td {
            font-size: 18px;
            vertical-align: middle;
            width: 300px;
            height: 50px;
            border-bottom: #c8c8c8 solid 4px;
        }

        /* 2행의 높이 스타일 */
        tr:last-child {
            height: 200px;
        }

        /* 테이블 테두리 제거 */
        table {
            border-collapse: separate;
    border-spacing: 20px; 
            align-self: center;
            border: 0px ;
            
        }

#challengeAuthContent {
    width: 71%;
    margin-bottom: 10px;
    height: 100px;
}

</style>
</head>
<body>

<div layout:fragment="content">

    <div class="text-center">
        <div class="btn-group" role="group" aria-label="Basic radio toggle button group" style="width: 800px; margin-bottom: 5px; margin-top: 20px;">
            <!-- 홈 버튼 -->
            <input type="radio" class="btn-check" name="btnradio" id="btnradio1" autocomplete="off" checked>
            <label class="btn btn-custom" for="btnradio1" onclick="showHomeContent()">
                <span style="color: black;">홈</span>
                <div class="underline"></div> <!-- 밑줄 요소 추가 -->
            </label>
            <!-- 리뷰 버튼 -->
            <input type="radio" class="btn-check" name="btnradio" id="btnradio2" autocomplete="off">
            <label class="btn btn-custom" for="btnradio2" onclick="showReviewContent()">
                <span style="color: black;">인증하기</span>
                <div class="underline"></div> <!-- 밑줄 요소 추가 -->
            </label>
           
        </div>
    </div>

    <div class="container">
        <div class="row justify-content-end homeaticle">
            <div class="col-8 mx-2 fixed-width-col">
    
                <div class="yj-img">
                    <img th:src="@{${'/image/challenge/challengeList/' + challengeDTO.challengeImageMain}}" alt="">
                    <div class="Main_content" >

                        <div class="round-image">
                                <img style="margin-bottom: 30px;" th:src="@{|/image/login/${masterInfoDTO.picture}|}" alt="">
                        </div>

                        <p class="Yj-master" th:text="${masterInfoDTO.email}"></p>
                        <p class="Yj-title" th:text="${challengeDTO.challengeTitle}"></p>
                    </div>
                  
                    <div class="main-text">
                        <p class="Yj-text1" th:text="${challengeDTO.challengeContent}"></p>
                        
                        <br/>
                        <br/>
                        <br/>
                        <br/>

                        <table>
                            <tr>
                                <td><i class="fa-solid fa-check" style="color: #e60f0f;"></i> 인증 성공 예시</td>
                                <td><i class="fa-solid fa-xmark" style="color: #e60f0f;"></i> 인증 실패 예시</td>
                            </tr>
                            <tr style="width: 100%; height: 100%;">
                                
                                <td><img th:src="@{|/image/challenge/challengeList/${challengeDTO.challengeImageSuccess}|}" alt=""></td>
                                <td><img th:src="@{|/image/challenge/challengeList/${challengeDTO.challengeImageFail}|}" alt=""></td>
                            </tr>
                        </table>
                       



                        <div class="yj-info">상세 정보</div>
                        <p class="text-with-hyphen Yj-text2">
                            인증 빈도 : <span th:text="${challengeDTO.challengeWeekCheck}"></span>
                        </p>

                        <div th:if="${challengeDTO.challengeDateCheck}==1week">
                            <p class="text-with-hyphen Yj-text2">
                                인증 기간 : 1주일 동안!
                            </p>
                        </div>
                        <div th:if="${challengeDTO.challengeDateCheck}==2week">
                            <p class="text-with-hyphen Yj-text2">
                                인증 기간 : 2주일 동안!
                            </p>
                        </div>
                        <div th:if="${challengeDTO.challengeDateCheck}==3week">
                            <p class="text-with-hyphen Yj-text2">
                                인증 기간 : 3주일 동안!
                            </p>
                        </div>
                        <div th:if="${challengeDTO.challengeDateCheck}==1month">
                            <p class="text-with-hyphen Yj-text2">
                                인증 기간 : 1달 동안!
                            </p>
                        </div>
                    
                        <p class="text-with-hyphen Yj-text2">
                            <span th:text="${challengeDTO.challengeStartDate}"></span> 부터 <span th:text="${challengeDTO.challengeEndDate}"></span> 까지!
                        </p>

                        <div class="yj-inwon">현재참가 인원</div>
                        <div class="text-container">
                            <p class="Yj-text3" th:text="${challengeDTO.challengeMemberCount}"></p>
                        </div>


                        


                        <div th:switch="${ChallengeMemberStatus != null}">
                            <div th:case="true">
                                <div th:switch="${ChallengeMemberStatus}">

                                    <div th:case="-1">
                                        <form action="/joinChallenge.action" method="post">
                                        &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            <button type="submit" class="join-button">
                                                가입하기
                                            </button>
                                            <input type="hidden" name="challengeListNum" id="challengeListnum" th:value="${challengeDTO.challengeListNum}"/>
                                        </form>
                                    </div>

                                    <div th:case="1">
                                        <form action="/deleteChallenge.action" method="post">
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            <button type="submit" class="delete-button">
                                                챌린지 삭제
                                            </button>
                                            <input type="hidden" name="challengeListNum" id="challengeListnum" th:value="${challengeDTO.challengeListNum}"/>
                                        </form>                           
                                    </div>

                                    <div th:case="2">
                                        <form action="/giveUpChallenge" method="post">
                                            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
                                            <button type="submit" class="out-button">
                                                챌린지 포기하기
                                            </button>
                                            <input type="hidden" name="challengeListNum" id="challengeListnum" th:value="${challengeDTO.challengeListNum}"/>
                                        </form>
                                    </div>

                                </div>
                            </div>
                        </div>
                        
                    </div>
                </div>
            </div>
            <div class="col-md-2">
                <div class="meet-members">
                    <p>
                        <span style="margin-right: 37px; margin-left: 12px;">멤버목록</span>
                    </p>
                    <div class="meet-mem-list" th:each="challengeMember : ${lists}">
                        <li class="round-image-rev mt-2" style="margin-right: 10px; margin-left: -10px;">
                            <!-- <img th:src="@{/image/gatchiImage/1111.jpg}" alt="유저프사(임의)"/> -->
                        </li>
                        <li class="custom-li" th:text="${challengeMember.name}"></li>
                    </div>
                </div>
            </div>
        </div>


    </div>

    <div class="yj-img2">
        <div class="review-title">인증</div>
        <div class="review-sub">이 챌린지에서 당신의 생생한 후기를 남겨보세요!</div>
        
        <div class="review-write" th:if="${ChallengeMemberStatus == 2 or ChallengeMemberStatus == 1}">작성하기</div>

        <form action="/uploadAuth" method="POST" enctype="multipart/form-data">
            <div class="review-form" style="display: none;">
                <div class="review-input">
                    <textarea name="challengeAuthContent" id="challengeAuthContent" placeholder=" 챌린지 인증내용을 작성해주세요."></textarea>
                    <input type="file" name="challengeAuthImage" id="challengeAuthImage" accept="image/*">
                    <input type="hidden" id="challengeListNum" name="challengeListNum" th:value="${challengeDTO.challengeListNum}" />
                    <button id="submit-review">등록하기</button>
                </div>
            </div>
        </form>

        <th:block th:if="${#lists.isEmpty(allReviewList)}">
            <div class="no-review">
                등록된 챌린지 인증이 없습니다.
            </div>
        </th:block>

        <th:block th:unless="${#lists.isEmpty(allReviewList)}">
            <div class="d-flex justify-content-center mb-4" th:each="allReviewList : ${allReviewList}">
                <div class="card" style="width: 36rem; margin-bottom: 20px; border:none;">
                    <div class="card-body">
                        <div class="d-flex flex-column mb-2">
                            <div class="round-image-user mt-2">
                                <img th:src="@{${'/image/login/' + allReviewList.picture}}" alt="유저프사(임의)"/>
                            </div>
                            <p class="memid" th:text="${allReviewList.email}"></p>
                            <div class="col-md-4 mx-auto" style="width: 300px; height: 300px; overflow: hidden; border-radius: 5px; margin-bottom: 10px; margin-top: 10px;">
                                <img th:src="@{${'/image/challenge/challengeCheck/' + allReviewList.challengeAuthImage}}" class="img-fluid rounded-start" alt="리뷰사진" style="width: 100%; height: 100%; object-fit: cover; cursor: pointer;" onclick="openModal(this);">
                            </div>
                        </div>

                        <div th:if="${ChallengeMemberStatus == 2}"> 
                            <button value="ㅇㅇ">버튼</button>
                        </div>

                        <div th:unless="${ChallengeMemberStatus == 1}">
                            <div th:if="${allReviewList.challengeAuthStatus==0}">
                                <span style="display: inline-block;">
                                    <i class="fa-solid fa-spinner" style="color: #929292;"></i>
                                </span>
                                <h5 style="display: inline; color: rgb(146, 146, 146);">인증중</h5>
                            </div>
                            <div th:if="${allReviewList.challengeAuthStatus==0}">
                                <span style="display: inline-block;">
                                    <i class="fa-regular fa-circle-check" style="color: #008000;"></i>
                                </span>
                                <h5 style="display: inline; color: rgb(0, 128, 0);">인증완료!</h5>
                            </div>
                            <div th:if="${allReviewList.challengeAuthStatus==0}">
                                <span style="display: inline-block;">
                                    <i class="fa-solid fa-triangle-exclamation" style="color: #ff0000;"></i>
                                </span>
                                <h5 style="display: inline; color: rgb(255, 0, 0);">인증실패..</h5>
                            </div>
                        </div>
                       

                        <p class="card-text" th:text="${allReviewList.challengeAuthContent}" style="padding-left: 10px; padding-right: 10px; text-align: justify; font-size: 18px; margin-bottom: 5px;"></p>
                        
                        <p class="card-text d-flex" th:text="${allReviewList.challengeAuthCreateDate}" style="color: #AAAAAA; font-size: 13px; position: absolute; top: 0; right: 0; margin-top: 31px; margin-right: 20px;"></p>

                        <span class="card-text d-flex delete-review" style="color: #AAAAAA; font-size: 13px; position: absolute; top: 0; right: 0; margin-top: 50px; margin-right: 20px;" 
                        th:if="${allReviewList.email == challengeInfoDTO.email}" 
                        th:data-email="${allReviewList.email}" 
                        th:data-challengeListNum="${allReviewList.challengeListNum}" 
                        th:data-challengeAuthListNum="${allReviewList.challengeAuthListNum}",
                        th:data-challengeAuthImage="${allReviewList.challengeAuthImage}"

                        onclick="deleteReview(
                            this.getAttribute('data-email'), 
                            this.getAttribute('data-challengeListNum'), 
                            this.getAttribute('data-challengeAuthListNum'),
                            this.getAttribute('data-challengeAuthImage'))">삭제</span>

                    </div>
                </div>
            </div>
        </th:block>

    </div>






        
</div>

</body>
</html>